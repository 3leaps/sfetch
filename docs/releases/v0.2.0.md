# sfetch v0.2.0

Major feature release: verification assessment, provenance records, checksum-only workflow, and adoption of Semantic Versioning.

## Checklist
- [x] `make precommit` (includes tests, staticcheck, gosec, shellcheck)
- [x] Integration tests for minisign verification
- [x] Unit tests for minisign public key validation
- [x] Dry-run tested against real repos (ripgrep, lazygit, fzf)
- [x] Provenance schema validates with JSON Schema 2020-12

## Changes

### 1. Verification Assessment (`--dry-run`)

Assess what verification is available without downloading:

```bash
$ sfetch --repo BurntSushi/ripgrep --latest --dry-run

sfetch dry-run assessment
-------------------------
Repository:  BurntSushi/ripgrep
Release:     15.1.0
Asset:       ripgrep-15.1.0-aarch64-apple-darwin.tar.gz (1.7 MB)

Verification available:
  Signature:  none
  Checksum:   ripgrep-15.1.0-aarch64-apple-darwin.tar.gz.sha256 (sha256, per-asset)

Verification plan:
  Workflow:   C (checksum-only)
  Trust:      low

Warnings:
  - No signature available; authenticity cannot be proven
```

### 2. Provenance Records

Structured JSON output for audit trails and CI integration:

```bash
# Output to stderr
sfetch --repo 3leaps/sfetch --latest --dest-dir /tmp --provenance

# Write to file
sfetch --repo 3leaps/sfetch --latest --dest-dir /tmp --provenance-file audit.json

# Dry-run with JSON output
sfetch --repo BurntSushi/ripgrep --latest --dry-run --provenance
```

**Schema**: `schemas/provenance.schema.json`

Provenance record includes:
- Source repository and release metadata
- Asset name, size, URL, computed checksum
- Verification workflow used (A/B/C/insecure)
- Signature and checksum verification status
- Trust level assessment
- Warnings generated

### 3. Workflow C (Checksum-Only)

Support for repos that publish checksums but no signatures:

| Repo | Checksum Pattern | Status |
|------|------------------|--------|
| BurntSushi/ripgrep | per-asset `.sha256` | Supported |
| jesseduffield/lazygit | `checksums.txt` | Supported |
| junegunn/fzf | `checksums.txt` | Supported |

Warning emitted: "No signature available; authenticity cannot be proven"

### 4. Override Flags

Explicit user control over verification:

| Flag | Description |
|------|-------------|
| `--skip-checksum` | Skip checksum verification even if available |
| `--insecure` | Skip ALL verification (dangerous) |

### 5. Minisign Enhancements

**Key discovery**:
- `--minisign-key-url <url>`: Download key from URL
- `--minisign-key-asset <name>`: Use key from release asset
- Auto-detection of `.pub` files in release assets

**Policy enforcement**:
- `--require-minisign`: Fail if minisign not available
- `--prefer-per-asset`: Force Workflow B over Workflow A

**Safety validation**:
- `--verify-minisign-pubkey <path>`: Validate file is a PUBLIC key (not secret)
- Makefile target `release-export-minisign-key` now validates before copying

### 6. Inference Improvements

- Binary name inferred from repo name (`jedisct1/minisign` -> `minisign`)
- Archive type inferred from asset extension (`.tar.gz`, `.zip`, `.tgz`)
- `--binary-name <name>`: Override inferred name when needed

### 7. Documentation

- `docs/examples.md`: Comprehensive real-world examples
- Pattern matching transparency (how sfetch selects assets)
- Decision flow diagrams for Workflow A/B/C
- Dogfooding log with tested repos

## New CLI Flags

```
--dry-run                 Assess release without downloading
--provenance              Output provenance JSON to stderr
--provenance-file <path>  Write provenance to file
--skip-checksum           Skip checksum verification
--insecure                Skip ALL verification (dangerous)
--minisign-key-url <url>  Download minisign key from URL
--minisign-key-asset <n>  Use minisign key from release asset
--require-minisign        Fail if minisign not available
--prefer-per-asset        Force per-asset signature workflow
--binary-name <name>      Override inferred binary name
--verify-minisign-pubkey  Validate minisign public key file
```

## Trust Levels

| Level | Criteria | Example |
|-------|----------|---------|
| high | Signature + checksum verified | 3leaps/sfetch, fulmenhq/goneat |
| medium | Signature verified, no checksum | jedisct1/minisign |
| low | Checksum only, no signature | BurntSushi/ripgrep, junegunn/fzf |
| none | No verification (`--insecure`) | - |

## Deployment Notes
- Tag: `v0.2.0`
- Trust anchor unchanged: `RWTAoUJ007VE3h8tbHlBCyk2+y0nn7kyA4QP34LTzdtk8M6A2sryQtZC`
- New dependency: `github.com/jedisct1/go-minisign` (pure-Go minisign verification)
- New dependency: `github.com/santhosh-tekuri/jsonschema/v6` (JSON Schema validation)
- New schema: `schemas/provenance.schema.json`
- Versioning: Adopted Semantic Versioning (see [ADR-0001](../adr/adr-0001-semver-versioning.md))

## Migration Notes

No breaking changes. All new flags are additive:
- `--skip-sig` behavior unchanged
- Existing workflows (A, B) unchanged
- New Workflow C automatically used when only checksums available
